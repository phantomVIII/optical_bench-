<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBSE 3D Optical Bench Simulation</title>
    <style>
        /* CSS Variables for easy theme switching */
        :root {
            --bg-color: #e8eaf6;
            --ui-bg: rgba(255, 255, 255, 0.95);
            --text-main: #333;
            --text-sub: #555;
            --stats-bg: #f0f0f0;
            --border-color: #ddd;
        }

        [data-theme="dark"] {
            --bg-color: #121212;
            --ui-bg: rgba(30, 30, 30, 0.95);
            --text-main: #e0e0e0;
            --text-sub: #bbb;
            --stats-bg: #2d2d2d;
            --border-color: #444;
        }

        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg-color); }
        
        #ui { 
            position: absolute; top: 20px; left: 20px; 
            background: var(--ui-bg); 
            padding: 20px; border-radius: 12px; 
            width: 280px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 100;
            transition: transform 0.3s ease, opacity 0.3s ease, background 0.3s ease;
            color: var(--text-main);
        }

        #ui.hidden { transform: translateX(-350px); opacity: 0; pointer-events: none; }

        .btn-container { position: absolute; top: 20px; left: 20px; z-index: 101; display: flex; gap: 5px; }

        button.control-btn {
            padding: 2px 10px; background: #333; color: white;
            border: none; border-radius: 6px; cursor: pointer; font-size: 12px;
            transition: background 0.2s;
        }
        button.control-btn:hover { background: #555; }

        h2 { margin: 0 0 10px 0; font-size: 18px; color: var(--text-main); border-bottom: 2px solid var(--border-color); padding-bottom: 5px; }
        label { display: block; margin-top: 15px; font-size: 13px; color: var(--text-sub); font-weight: bold; }
        input[type="range"] { width: 100%; cursor: pointer; }
        select { width: 100%; padding: 8px; margin-top: 5px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--ui-bg); color: var(--text-main); }
        
        .stats { background: var(--stats-bg); padding: 10px; border-radius: 6px; margin-top: 15px; }
        .stats p { margin: 5px 0; font-size: 14px; font-family: monospace; }
        .value-text { color: #d32f2f; font-weight: bold; }
        .hint { font-size: 11px; color: var(--text-sub); margin-top: 10px; font-style: italic; }
    </style>
</head>
<body>

<div class="btn-container">
    <button id="toggleUI" class="control-btn">Hide Menu</button>
    <button id="toggleTheme" class="control-btn">ðŸŒ™ Dark Mode</button>
</div>

<div id="ui">
    <h2>Optical Bench 3D</h2>
    
    <label>Lens Type:</label>
    <select id="lensType">
        <option value="convex">Convex (Converging)</option>
        <option value="concave">Concave (Diverging)</option>
    </select>

    <label>Focal Length (f): <span id="fVal" class="value-text">20</span> cm</label>
    <input type="range" id="fSlider" min="10" max="40" value="20">
    
    <label>Object Position (u): <span id="uVal" class="value-text">-40</span> cm</label>
    <input type="range" id="uSlider" min="-100" max="-10" value="-40">
    
    <div class="stats">
        <p>Image Dist (v): <span id="vDisplay" class="value-text">40.00</span> cm</p>
        <p>Magnification: <span id="mDisplay" class="value-text">-1.00</span></p>
        <p>Nature: <span id="natureDisplay" class="value-text">Real & Inverted</span></p>
    </div>
    <div class="hint">Right-click to pan â€¢ Left-click to rotate â€¢ Scroll to zoom</div>
</div>

<script type="importmap">
    { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "controls": "https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js" } }
</script>

<script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'controls';

    // --- UI & THEME LOGIC ---
    const ui = document.getElementById('ui');
    const toggleBtn = document.getElementById('toggleUI');
    const themeBtn = document.getElementById('toggleTheme');
    let isDark = false;

    toggleBtn.addEventListener('click', () => {
        ui.classList.toggle('hidden');
        toggleBtn.innerText = ui.classList.contains('hidden') ? 'Show Menu' : 'Hide Menu';
    });

    themeBtn.addEventListener('click', () => {
        isDark = !isDark;
        document.body.setAttribute('data-theme', isDark ? 'dark' : 'light');
        themeBtn.innerText = isDark ? 'â˜€ï¸ Light Mode' : 'ðŸŒ™ Dark Mode';
        
        // Update Three.js Background
        scene.background.set(isDark ? 0x121212 : 0xe8eaf6);
        // Update Grid Helper Color
        scale.material.color.set(isDark ? 0x444444 : 0x000000);
    });

    // --- SCENE SETUP ---
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0xe8eaf6);
    const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    camera.position.set(80, 50, 120);
    controls.enableDamping = true;

    // --- LIGHTING ---
    scene.add(new THREE.AmbientLight(0xffffff, 0.8));
    const pointLight = new THREE.PointLight(0xffffff, 1.2);
    pointLight.position.set(50, 80, 50);
    scene.add(pointLight);

    // --- MODELS ---
    const bench = new THREE.Mesh(
        new THREE.BoxGeometry(12, 2, 300), 
        new THREE.MeshStandardMaterial({ color: 0x4e342e })
    );
    scene.add(bench);

    const scale = new THREE.GridHelper(300, 30, 0x000000, 0xbbbbbb);
    scale.rotation.z = Math.PI/2;
    scale.position.y = 1.1;
    scene.add(scale);

    const lensGroup = new THREE.Group();
    const lensBody = new THREE.Mesh(
        new THREE.CylinderGeometry(15, 15, 1.5, 32),
        new THREE.MeshPhongMaterial({ color: 0x81d4fa, transparent: true, opacity: 0.6, shininess: 100 })
    );
    lensBody.rotation.x = Math.PI / 2;
    lensGroup.add(lensBody);
    scene.add(lensGroup);

    function createNeedle(color) {
        const group = new THREE.Group();
        const stand = new THREE.Mesh(new THREE.BoxGeometry(4, 15, 2), new THREE.MeshStandardMaterial({color: 0x333333}));
        const pin = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.2, 12), new THREE.MeshStandardMaterial({color: 0x222222}));
        const tip = new THREE.Mesh(new THREE.ConeGeometry(0.4, 2, 8), new THREE.MeshStandardMaterial({color: color}));
        stand.position.y = 7.5; pin.position.y = 18; tip.position.y = 24;
        group.add(stand, pin, tip);
        return group;
    }

    const objNeedle = createNeedle(0xd32f2f);
    const imgNeedle = createNeedle(0x1976d2);
    scene.add(objNeedle, imgNeedle);

    let rayLines = [];
    const rayMatReal = new THREE.LineBasicMaterial({ color: 0xffa000 });

    function updatePhysics() {
        const u = parseFloat(document.getElementById('uSlider').value);
        let fInput = parseFloat(document.getElementById('fSlider').value);
        const type = document.getElementById('lensType').value;
        const f = (type === "concave") ? -fInput : fInput;
        const v = (f * u) / (f + u);
        const m = v / u;

        lensBody.scale.set(1, (type === "concave" ? 0.4 : 1.5), 1);
        document.getElementById('uVal').innerText = u;
        document.getElementById('fVal').innerText = Math.abs(f);
        document.getElementById('vDisplay').innerText = v.toFixed(2);
        document.getElementById('mDisplay').innerText = m.toFixed(2);
        
        let nature = (type === "convex") ? (v > 0 ? "Real & Inverted" : "Virtual & Erect") : "Virtual, Erect & Diminished";
        document.getElementById('natureDisplay').innerText = nature;

        objNeedle.position.z = -u;
        imgNeedle.position.z = v;
        imgNeedle.scale.y = Math.abs(m);
        imgNeedle.rotation.x = (m < 0) ? Math.PI : 0;
        imgNeedle.position.y = (m < 0) ? 24 * Math.abs(m) : 0; 

        scene.remove(...rayLines);
        rayLines = [];
        const tipPos = new THREE.Vector3(0, 24, -u);
        const imgTipPos = new THREE.Vector3(0, 24 * m, v);
        
        createLine([tipPos, new THREE.Vector3(0, 24, 0), imgTipPos]);
        createLine([tipPos, new THREE.Vector3(0, 0, 0), imgTipPos]);
    }

    function createLine(points) {
        const geo = new THREE.BufferGeometry().setFromPoints(points);
        const line = new THREE.Line(geo, rayMatReal);
        rayLines.push(line);
        scene.add(line);
    }

    document.getElementById('uSlider').addEventListener('input', updatePhysics);
    document.getElementById('fSlider').addEventListener('input', updatePhysics);
    document.getElementById('lensType').addEventListener('change', updatePhysics);
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

    function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
    }

    updatePhysics();
    animate();
</script>
</body>
</html>
